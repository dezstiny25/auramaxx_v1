//Auramaxx-ESP32.ino

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <ArduinoJson.h>

// ================== BLE UUIDs ==================
#define SERVICE_UUID        "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define RX_UUID             "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define TX_UUID             "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

// ================== RELAY PINS (ACTIVE LOW) ==================
#define FL_PIN 16
#define FR_PIN 17
#define RL_PIN 18
#define RR_PIN 19

// ================== GLOBALS ==================
BLECharacteristic *rxChar;
BLECharacteristic *txChar;

String currentMode = "Off";
int offDelayMs = 500;

bool zoneFL = false;
bool zoneFR = false;
bool zoneRL = false;
bool zoneRR = false;

unsigned long lastTick = 0;
bool pulseOn = false;
int chaseIndex = 0;
int loopDir = 1; // 1 = forward, -1 = backward for Loop mode
bool loopRepeat = false; // used to duplicate endpoints in Loop mode
bool altState = false; // toggles between groups for Alternate mode

// ================== HELPERS ==================
void relayWrite(int pin, bool on) {
  digitalWrite(pin, on ? LOW : HIGH); // ACTIVE LOW
}

void allOff() {
  relayWrite(FL_PIN, false);
  relayWrite(FR_PIN, false);
  relayWrite(RL_PIN, false);
  relayWrite(RR_PIN, false);
}

void applyZones(bool on) {
  relayWrite(FL_PIN, zoneFL && on);
  relayWrite(FR_PIN, zoneFR && on);
  relayWrite(RL_PIN, zoneRL && on);
  relayWrite(RR_PIN, zoneRR && on);
}

void notifyState() {
  StaticJsonDocument<128> doc;
  doc["mode"] = currentMode;
  JsonArray z = doc.createNestedArray("zones");
  if (zoneFL) z.add("front_left");
  if (zoneFR) z.add("front_right");
  if (zoneRL) z.add("rear_left");
  if (zoneRR) z.add("rear_right");

  String out;
  serializeJson(doc, out);
  txChar->setValue(out.c_str());
  txChar->notify();
}

// ================== BLE CALLBACK ==================
class RXCallbacks : public BLECharacteristicCallbacks {
  void onWrite(BLECharacteristic *c) override {
    String payload = c->getValue().c_str();

    StaticJsonDocument<256> doc;
    if (deserializeJson(doc, payload)) return;

    zoneFL = zoneFR = zoneRL = zoneRR = false;

    for (JsonVariant z : doc["zones"].as<JsonArray>()) {
      String s = z.as<String>();
      if (s == "front_left") zoneFL = true;
      if (s == "front_right") zoneFR = true;
      if (s == "rear_left") zoneRL = true;
      if (s == "rear_right") zoneRR = true;
    }

    currentMode = doc["mode"].as<String>();
    offDelayMs = doc["speed"] | 500;

    if (currentMode == "Off") {
      allOff();
    }

    notifyState();
  }
};

// ================== SETUP ==================
void setup() {
  Serial.begin(115200);

  pinMode(FL_PIN, OUTPUT);
  pinMode(FR_PIN, OUTPUT);
  pinMode(RL_PIN, OUTPUT);
  pinMode(RR_PIN, OUTPUT);

  allOff();

  // Startup animation
  relayWrite(FL_PIN, true); delay(120);
  relayWrite(FR_PIN, true); delay(120);
  relayWrite(RL_PIN, true); delay(120);
  relayWrite(RR_PIN, true); delay(120);
  allOff();

  BLEDevice::init("AuraMaxx");
  BLEServer *server = BLEDevice::createServer();
  BLEService *service = server->createService(SERVICE_UUID);

  rxChar = service->createCharacteristic(RX_UUID, BLECharacteristic::PROPERTY_WRITE);
  txChar = service->createCharacteristic(TX_UUID, BLECharacteristic::PROPERTY_NOTIFY);

  rxChar->setCallbacks(new RXCallbacks());
  txChar->addDescriptor(new BLE2902());

  service->start();
  BLEDevice::getAdvertising()->addServiceUUID(SERVICE_UUID);
  BLEDevice::getAdvertising()->start();
}

// ================== LOOP ==================
void loop() {
  unsigned long now = millis();

  if (currentMode == "Solid") {
    applyZones(true);
    pulseOn = false;
    lastTick = now;
    return;
  }

  if (currentMode == "Off") {
    allOff();
    pulseOn = false;
    return;
  }

  // If not currently in a short ON pulse, check if it's time to start one
  if (!pulseOn) {
    if (now - lastTick >= (unsigned long)offDelayMs) {
      pulseOn = true;
      lastTick = now;

      if (currentMode == "Strobe") {
        applyZones(true);
      } else if (currentMode == "Chase") {
        allOff();
        if (chaseIndex == 0 && zoneFL) relayWrite(FL_PIN, true);
        if (chaseIndex == 1 && zoneFR) relayWrite(FR_PIN, true);
        if (chaseIndex == 2 && zoneRL) relayWrite(RL_PIN, true);
        if (chaseIndex == 3 && zoneRR) relayWrite(RR_PIN, true);
      } else if (currentMode == "Loop") {
        // bounce back pattern with duplicated endpoints
        allOff();
        if (chaseIndex == 0 && zoneFL) relayWrite(FL_PIN, true);
        if (chaseIndex == 1 && zoneFR) relayWrite(FR_PIN, true);
        if (chaseIndex == 2 && zoneRL) relayWrite(RL_PIN, true);
        if (chaseIndex == 3 && zoneRR) relayWrite(RR_PIN, true);
      } else if (currentMode == "Alternate") {
        // Toggle between front (FL/FR) and rear (RL/RR) groups
        altState = !altState;
        if (altState) {
          if (zoneFL) relayWrite(FL_PIN, true);
          if (zoneFR) relayWrite(FR_PIN, true);
        } else {
          if (zoneRL) relayWrite(RL_PIN, true);
          if (zoneRR) relayWrite(RR_PIN, true);
        }
      } else if (currentMode == "Random") {
        allOff();
        if (random(0, 2)) relayWrite(FL_PIN, true);
        if (random(0, 2)) relayWrite(FR_PIN, true);
        if (random(0, 2)) relayWrite(RL_PIN, true);
        if (random(0, 2)) relayWrite(RR_PIN, true);
      }
    }
  }

  // If in a pulse, wait for the short pulse duration then turn off and advance state
  else {
    if (now - lastTick >= 50) {
      allOff();
      pulseOn = false;
      lastTick = now;
      if (currentMode == "Chase") {
        chaseIndex = (chaseIndex + 1) % 4;
      } else if (currentMode == "Loop") {
        // advance with bounce and duplicate endpoints
        if (loopDir == 1) {
          if (chaseIndex < 3) {
            chaseIndex++;
          } else {
            if (!loopRepeat) {
              loopRepeat = true; // repeat the endpoint once
            } else {
              loopDir = -1;
              loopRepeat = false;
              chaseIndex = 2;
            }
          }
        } else { // backward
          if (chaseIndex > 0) {
            chaseIndex--;
          } else {
            if (!loopRepeat) {
              loopRepeat = true;
            } else {
              loopDir = 1;
              loopRepeat = false;
              chaseIndex = 1;
            }
          }
        }
      }
    }
  }
}
