#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <ArduinoJson.h>

// ================== BLE UUIDs ==================
#define SERVICE_UUID        "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define RX_UUID             "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define TX_UUID             "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

// ================== RELAY PINS (ACTIVE LOW) ==================
#define FL_PIN 16
#define FR_PIN 17
#define RL_PIN 18
#define RR_PIN 19

// ================== GLOBALS ==================
BLECharacteristic *rxChar;
BLECharacteristic *txChar;

String currentMode = "Off";
int offDelayMs = 500;

bool zoneFL = false;
bool zoneFR = false;
bool zoneRL = false;
bool zoneRR = false;

unsigned long lastTick = 0;
bool pulseOn = false;
int chaseIndex = 0;

// ================== HELPERS ==================
void relayWrite(int pin, bool on) {
  digitalWrite(pin, on ? LOW : HIGH); // ACTIVE LOW
}

void allOff() {
  relayWrite(FL_PIN, false);
  relayWrite(FR_PIN, false);
  relayWrite(RL_PIN, false);
  relayWrite(RR_PIN, false);
}

void applyZones(bool on) {
  relayWrite(FL_PIN, zoneFL && on);
  relayWrite(FR_PIN, zoneFR && on);
  relayWrite(RL_PIN, zoneRL && on);
  relayWrite(RR_PIN, zoneRR && on);
}

void notifyState() {
  StaticJsonDocument<128> doc;
  doc["mode"] = currentMode;
  JsonArray z = doc.createNestedArray("zones");
  if (zoneFL) z.add("front_left");
  if (zoneFR) z.add("front_right");
  if (zoneRL) z.add("rear_left");
  if (zoneRR) z.add("rear_right");

  String out;
  serializeJson(doc, out);
  txChar->setValue(out.c_str());
  txChar->notify();
}

// ================== BLE CALLBACK ==================
class RXCallbacks : public BLECharacteristicCallbacks {
  void onWrite(BLECharacteristic *c) override {
    String payload = c->getValue().c_str();

    StaticJsonDocument<256> doc;
    if (deserializeJson(doc, payload)) return;

    zoneFL = zoneFR = zoneRL = zoneRR = false;

    for (JsonVariant z : doc["zones"].as<JsonArray>()) {
      String s = z.as<String>();
      if (s == "front_left") zoneFL = true;
      if (s == "front_right") zoneFR = true;
      if (s == "rear_left") zoneRL = true;
      if (s == "rear_right") zoneRR = true;
    }

    currentMode = doc["mode"].as<String>();
    offDelayMs = doc["speed"] | 500;

    if (currentMode == "Off") {
      allOff();
    }

    notifyState();
  }
};

// ================== SETUP ==================
void setup() {
  Serial.begin(115200);

  pinMode(FL_PIN, OUTPUT);
  pinMode(FR_PIN, OUTPUT);
  pinMode(RL_PIN, OUTPUT);
  pinMode(RR_PIN, OUTPUT);

  allOff();

  // Startup animation
  relayWrite(FL_PIN, true); delay(120);
  relayWrite(FR_PIN, true); delay(120);
  relayWrite(RL_PIN, true); delay(120);
  relayWrite(RR_PIN, true); delay(120);
  allOff();

  BLEDevice::init("AuraMaxx");
  BLEServer *server = BLEDevice::createServer();
  BLEService *service = server->createService(SERVICE_UUID);

  rxChar = service->createCharacteristic(RX_UUID, BLECharacteristic::PROPERTY_WRITE);
  txChar = service->createCharacteristic(TX_UUID, BLECharacteristic::PROPERTY_NOTIFY);

  rxChar->setCallbacks(new RXCallbacks());
  txChar->addDescriptor(new BLE2902());

  service->start();
  BLEDevice::getAdvertising()->addServiceUUID(SERVICE_UUID);
  BLEDevice::getAdvertising()->start();
}

// ================== LOOP ==================
void loop() {
  unsigned long now = millis();

  if (currentMode == "Solid") {
    applyZones(true);
    return;
  }

  if (now - lastTick < offDelayMs) return;
  lastTick = now;

  // Short ON pulse
  if (currentMode == "Strobe") {
    applyZones(true);
    delay(50);
    allOff();
  }

  else if (currentMode == "Chase") {
    allOff();
    if (chaseIndex == 0 && zoneFL) relayWrite(FL_PIN, true);
    if (chaseIndex == 1 && zoneFR) relayWrite(FR_PIN, true);
    if (chaseIndex == 2 && zoneRL) relayWrite(RL_PIN, true);
    if (chaseIndex == 3 && zoneRR) relayWrite(RR_PIN, true);
    delay(50);
    allOff();
    chaseIndex = (chaseIndex + 1) % 4;
  }

  else if (currentMode == "Random") {
    allOff();
    if (random(0, 2)) relayWrite(FL_PIN, true);
    if (random(0, 2)) relayWrite(FR_PIN, true);
    if (random(0, 2)) relayWrite(RL_PIN, true);
    if (random(0, 2)) relayWrite(RR_PIN, true);
    delay(50);
    allOff();
  }
}
